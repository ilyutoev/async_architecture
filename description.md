# Описание сервисов и их бизнес и CUD событий 

## Auth

CUD аккаунтов
```
Actor: Account
Command: Create/update/delete account 
Data: Account
Event: Account.Create / Update / Delete
```

### Таск-трекер
1. Таск-трекер должен быть отдельным дашбордом и доступен всем сотрудникам компании UberPopug Inc.

```
Actor: Account
Command: Login to task tracker app
Data:
Event: Account.Logined
```

2. Авторизация в таск-трекере должна выполняться через общий сервис авторизации UberPopug Inc (у нас там инновационная система авторизации на основе формы клюва).
3. В таск-трекере должны быть только задачи. Проектов, скоупов и спринтов нет, потому что они не умещаются в голове попуга.
4. Новые таски может создавать кто угодно (администратор, начальник, разработчик, менеджер и любая другая роль).
У задачи должны быть описание, статус (выполнена или нет) и попуг, на которого заассайнена задача.

```
Actor: Account
Command: Create task
Data: Task
Event: Task.Created
```

5. Менеджеры или администраторы должны иметь кнопку «заассайнить задачи», которая возьмёт все открытые задачи и рандомно заассайнит каждую на любого из сотрудников. Не успел закрыть задачу до реассайна — сорян, делай следующую. 
   - Ассайнить задачу можно на кого угодно, это может быть любой аккаунт из системы. 
   - Ассайнить задачу можно только кнопкой «заассайнить задачи» 
   - При нажатии кнопки «заассайнить задачи» все текущие не закрытые задачи должны быть случайным образом перетасованы между каждым аккаунтом в системе 
   - Мы не заморачиваемся на ограничение по нажатию на кнопку «заассайнить задачи». Её можно нажимать хоть каждую секунду.
   - На одного сотрудника может выпасть любое количество новых задач, может выпасть ноль, а может и 10.

```
Actor: Account (Role: Management/Administrator)
Command: Assign tasks to accounts
Data: Task + account pubic id
Event: Tasks.Assigned
```

6. Каждый сотрудник должен иметь возможность видеть в отдельном месте список заассайненных на него задач + отметить задачу выполненной.

```
Actor: Account
Command: Complete task
Data: Task
Event: Task.Completed
```

### Аккаунтинг: кто сколько денег заработал

1. Аккаунтинг должен быть в отдельном дашборде и доступным только для администраторов и бухгалтеров.
   **Updated:** у обычных попугов доступ к аккаунтингу тоже должен быть. 
   Но только к информации о собственных счетах (аудит лог + текущий баланс). 
   У админов и бухгалтеров должен быть доступ к общей статистике по деньгами заработанным 
   (количество заработанных топ-менеджментом за сегодня денег + статистика по дням).

2. Авторизация в дешборде аккаунтинга должна выполняться через общий сервис аутентификации UberPopug Inc.
3. У каждого из сотрудников должен быть свой счёт, который показывает, сколько за сегодня он получил денег.
   У счёта должен быть аудит лог того, за что были списаны или начислены деньги, 
   с подробным описанием каждой из задач.


```
Actor: Task.Assigned
Command: Update balance + create auditlog
Data: Balance + Account public id 
Event: Balance.Updated

Скорее всего это действия в рамках одного сервиса и одной транзакции бд, 
а не два отдельных события 

Actor: Task.Assigned
Command: Create debiting audit log
Data: AuditLog
Event: AuditLog.Debited ?? 

```


```
Actor: Task.Completed
Command: Update balance + create auditlog
Data: Balance + Account public id 
Event: Balance.Updated

Скорее всего это действия в рамках одного сервиса и одной транзакции бд, 
а не два отдельных события

Actor: Task.Completed
Command: Create accrual audit log
Data: AuditLog
Event: AuditLog.Accrued
```

4. Расценки:
    - цены на задачу определяется единоразово, в момент появления в системе (можно с минимальной задержкой)

```
Actor: Task.Created
Command: Estimate the cost of the task
Data: Task
Event: Task.Estimated
```

    - **Updated:** цены рассчитывается без привязки к сотруднику
    - **Updated:** формула, которая говорит сколько списать денег с сотрудника при ассайне задачи — `rand(-10..-20)$`
    - **Updated:** формула, которая говорит сколько начислить денег сотруднику для выполненой задачи — `rand(20..40)$`
    - деньги списываются сразу после ассайна на сотрудника, а начисляются после выполнения задачи.
    - отрицательный баланс переносится на следующий день. Единственный способ его погасить - закрыть достаточное количество задач в течении дня.

5. Дешборд должен выводить количество заработанных топ-менеджментом за сегодня денег.
Т.е. сумма всех закрытых и созданных задач за день с противоположным знаком: `(sum(completed task amount) + sum(created task fee)) * -1`

6. В конце дня необходимо:
    a. считать сколько денег сотрудник получил за рабочий день

```
Actor: Sheduler.EndOfTheDay / celery
Command: Calculate the employees income
Data: Balance / AuditLog
Event: Balance.Calculate
```

    b. отправлять на почту сумму выплаты.

```
Actor: Balance.Calculate
Command: Send the payment amount to the email 
Data: ?
Event: Email.Send
```

7. После выплаты баланса (в конце дня) он должен обнуляться, и в аудитлоге всех операций аккаунтинга должно быть отображено, что была выплачена сумма.

8. Дашборд должен выводить информацию по дням, а не за весь период сразу.
    1. вообще хватит только за сегодня (всё равно попуги дальше не помнят), но если чувствуете, что успеете сделать аналитику за каждый день недели — будет круто

### Аналитика

Какой-то лог день - самая дорогая задача

1. Аналитика — это отдельный дашборд, доступный только админам.

2. Нужно указывать, сколько заработал топ-менеджмент за сегодня: сколько попугов ушло в минус.

Вести копию баланса?
На AuditLog.Debited что-то вешать?

3. Нужно показывать самую дорогую задачу за день, неделю или месяц.
    1. самой дорогой задачей является задача с наивысшей ценой из списка всех закрытых задач за определенный период времени

```
Actor: Task.Completed / AuditLog.Accrued?- но откуда
Command: Set the most expensive task for today 
Data: AnalyticLog ?
Event: AnalyticLog.Updated
```

    2. пример того, как это может выглядеть:        
        03.03 — самая дорогая задача — 28$
        02.03 — самая дорогая задача — 38$
        01.03 — самая дорогая задача — 23$
        01-03 марта — самая дорогая задача — 38$
